<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>تحويل ملف ووردبريس إلى بلوجر</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- استدعاء مكتبة xml-js من الملف المحلي -->
  <script src="xml-js.min.js"></script>
  <style>
    /* تنسيق شريط التقدم */
    .progress-container {
      width: 100%;
      background-color: #f3f4f6;
      border-radius: 0.5rem;
      overflow: hidden;
      display: none;
      margin-top: 1rem;
    }
    .progress-bar {
      height: 1.5rem;
      background-color: #3b82f6;
      width: 0%;
      transition: width 0.3s ease-in-out;
      text-align: center;
      color: white;
      font-weight: bold;
      line-height: 1.5rem;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
  <div class="bg-white p-8 rounded-lg shadow-lg max-w-md w-full">
    <h1 class="text-2xl font-bold mb-6 text-center text-blue-600">تحويل ملف ووردبريس إلى بلوجر</h1>
    <div class="mb-4">
      <label class="block text-gray-700 mb-2 font-medium" for="xmlFile">اختر ملف XML (ووردبريس):</label>
      <input type="file" id="xmlFile" accept=".xml" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
    </div>
    <div class="mb-4">
      <label class="block text-gray-700 mb-2 font-medium" for="imagePath">مسار استضافة الصور (اختياري):</label>
      <input type="text" id="imagePath" placeholder="مثال: https://your-host.com/images/" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
    </div>
    <!-- خيارات موجودة -->
    <div class="mb-4">
      <label class="flex items-center">
        <input type="checkbox" id="convertLinks" class="mr-2">
        <span class="text-gray-700">جعل الروابط قابلة للنقر ومميزة بلون</span>
      </label>
    </div>
    <div class="mb-4">
      <label class="flex items-center">
        <input type="checkbox" id="embedVideos" class="mr-2">
        <span class="text-gray-700">تضمين مقاطع الفيديو (مثل YouTube)</span>
      </label>
    </div>
    <div class="mb-4">
      <label class="flex items-center">
        <input type="checkbox" id="translateContent" class="mr-2">
        <span class="text-gray-700">ترجمة المحتوى</span>
      </label>
      <select id="targetLanguage" class="mt-2 w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
        <option value="" disabled selected>اختر اللغة المستهدفة</option>
        <option value="ar">العربية</option>
        <option value="en">الإنجليزية</option>
        <option value="es">الإسبانية</option>
        <option value="fr">الفرنسية</option>
      </select>
    </div>
    <!-- خيار إزالة التعليقات -->
    <div class="mb-4">
      <label class="flex items-center">
        <input type="checkbox" id="removeComments" class="mr-2">
        <span class="text-gray-700">إزالة التعليقات</span>
      </label>
    </div>
    <button id="convertBtn" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600 transition duration-200">تحويل وتنزيل</button>
    <p id="status" class="mt-4 text-center text-gray-600"></p>
    <!-- شريط التقدم -->
    <div id="progressContainer" class="progress-container">
      <div id="progressBar" class="progress-bar">0%</div>
    </div>
  </div>

  <!-- مكتبة FileSaver.js المحدثة -->
  <script>
    (function(global) {
      function saveAs(blob, name) {
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = name || 'download';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        setTimeout(() => window.URL.revokeObjectURL(url), 100);
      }
      global.saveAs = saveAs;
    })(this);
  </script>

  <!-- الكود الرئيسي لتحويل الملف -->
  <script>
    // تفعيل/تعطيل قائمة اختيار اللغة بناءً على خيار الترجمة
    document.getElementById('translateContent').addEventListener('change', function () {
      const targetLanguageSelect = document.getElementById('targetLanguage');
      targetLanguageSelect.disabled = !this.checked;
      if (!this.checked) {
        targetLanguageSelect.value = '';
      }
    });

    // دالة لتحديث شريط التقدم
    function updateProgress(current, total) {
      const progressBar = document.getElementById('progressBar');
      const progressContainer = document.getElementById('progressContainer');
      const percentage = Math.min((current / total) * 100, 100);
      progressContainer.style.display = 'block';
      progressBar.style.width = `${percentage}%`;
      progressBar.textContent = `${Math.round(percentage)}%`;
    }

    // دالة لترجمة النص باستخدام Google Translate API (غير رسمية)
    async function translateText(text, targetLang) {
      if (!text || targetLang === '') return text;
      try {
        const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=${targetLang}&dt=t&q=${encodeURIComponent(text)}`;
        const response = await fetch(url);
        const data = await response.json();
        let translatedText = '';
        if (data && data[0]) {
          data[0].forEach(segment => {
            if (segment[0]) translatedText += segment[0];
          });
        }
        return translatedText || text;
      } catch (error) {
        console.error('Translation error:', error);
        return text;
      }
    }

    // دالة لترجمة المحتوى مع الحفاظ على بنية HTML
    async function translateContent(content, targetLang) {
      if (!content || targetLang === '') return content;
      const htmlPattern = /(<[^>]+>)/g;
      const parts = content.split(htmlPattern);
      const translatedParts = await Promise.all(parts.map(async (part) => {
        if (htmlPattern.test(part)) {
          return part;
        }
        return await translateText(part, targetLang);
      }));
      return translatedParts.join('');
    }

    // تحويل تاريخ ووردبريس إلى تاريخ بلوجر (تنسيق محسّن)
    function convertDate(wpDate) {
      const date = new Date(wpDate);
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${day}/${month}/${year} ${hours}:${minutes}`;
    }

    // تحويل تاريخ ووردبريس إلى صيغة ISO مع التحقق من الصحة
    function convertToISODate(wpDate, fallbackDate) {
      const datePattern = /^[A-Za-z]{3}, \d{2} [A-Za-z]{3} \d{4} \d{2}:\d{2}:\d{2} \+\d{4}$/;
      if (!datePattern.test(wpDate)) {
        return fallbackDate ? new Date(fallbackDate).toISOString() : new Date().toISOString();
      }
      const date = new Date(wpDate);
      if (isNaN(date.getTime())) {
        return fallbackDate ? new Date(fallbackDate).toISOString() : new Date().toISOString();
      }
      return date.toISOString();
    }

    // استبدال روابط الصور بمسار جديد إذا تم تحديده
    function replaceImageUrls(content, imagePath) {
      if (!imagePath) return content;
      const imageUrlPattern = /<img[^>]+src=["'](.*?)["']/g;
      return content.replace(imageUrlPattern, (match, url) => {
        const newUrl = imagePath + url.substring(url.lastIndexOf('/') + 1);
        return match.replace(url, newUrl);
      });
    }

    // تحويل روابط الفيديو إلى فيديو مدمج (إذا تم تفعيل الخيار)
    function embedVideos(content) {
      const youtubePattern = /(https?:\/\/(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11}))/g;
      return content.replace(youtubePattern, (match, url, videoId) => {
        return `<iframe width="560" height="315" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe>`;
      });
    }

    // تحويل الروابط النصية المستقلة فقط إلى روابط قابلة للنقر (إذا تم تفعيل الخيار)
    function makeLinksClickable(content) {
      const urlPattern = /(^|\s)(https?:\/\/[^\s<>"']+)(?=\s|$|[.,!?])/g;
      return content.replace(urlPattern, (match, prefix, url) => {
        if (url.includes('youtube.com') || url.includes('youtu.be')) return match;
        return `${prefix}<a href="${url}" style="color: #1a73e8; text-decoration: underline;" target="_blank">${url}</a>`;
      });
    }

    // تنسيق المحتوى (الإبقاء على الصور مع جميع السمات)
    async function formatContent(content, convertLinks, embedVideosOption, targetLang) {
      let formattedContent = content;

      // إزالة عناصر <a> و<h2> فقط، مع الإبقاء على <img> بجميع السمات
      formattedContent = formattedContent.replace(/<a[^>]+href=["'](.*?)["'][^>]*>(.*?)<\/a>/g, '$1');
      formattedContent = formattedContent.replace(/<\/?h[1-6][^>]*>/g, '');

      // استبدال التواريخ
      const datePattern = /\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\+\d{2}:\d{2}/g;
      formattedContent = formattedContent.replace(datePattern, (date) => `<strong>${convertDate(date)}</strong>`);

      // تطبيق خيار تضمين الفيديوهات (قبل تحويل الروابط لتجنب التداخل)
      if (embedVideosOption) {
        formattedContent = embedVideos(formattedContent);
      }

      // تطبيق خيار تحويل الروابط إلى روابط قابلة للنقر
      if (convertLinks) {
        formattedContent = makeLinksClickable(formattedContent);
      }

      // ترجمة المحتوى إذا تم تفعيل الخيار
      if (targetLang) {
        formattedContent = await translateContent(formattedContent, targetLang);
      }

      return formattedContent;
    }

    // تحويل الملف
    document.getElementById('convertBtn').addEventListener('click', async function () {
      const fileInput = document.getElementById('xmlFile');
      const imagePath = document.getElementById('imagePath').value.trim();
      const convertLinks = document.getElementById('convertLinks').checked;
      const embedVideosOption = document.getElementById('embedVideos').checked;
      const translateContentOption = document.getElementById('translateContent').checked;
      const targetLanguage = document.getElementById('targetLanguage').value;
      const removeComments = document.getElementById('removeComments').checked;
      const status = document.getElementById('status');

      if (!fileInput.files.length) {
        status.textContent = 'الرجاء اختيار ملف XML!';
        return;
      }

      if (translateContentOption && !targetLanguage) {
        status.textContent = 'الرجاء اختيار لغة للترجمة!';
        return;
      }

      const file = fileInput.files[0];
      const reader = new FileReader();

      reader.onload = async function (e) {
        const xmlContent = e.target.result;
        status.textContent = 'جارٍ التحويل...' + (translateContentOption ? ' (قد يستغرق الترجمة بعض الوقت)' : '');

        try {
          // تحويل XML إلى JSON باستخدام xml-js
          const json = xml2js(xmlContent, { compact: true, spaces: 2 });
          const channel = json.rss.channel;
          const entries = channel.item;

          // استخراج بيانات المؤلف العامة (إن وجدت)
          const defaultAuthor = {
            name: channel['dc:creator']?._text || 'Unknown Author',
            email: 'unknown@example.com',
            uri: channel.link?._text || 'https://example.com'
          };

          // رأس الملف (مطابق للملف المرفق، بدون فراغات)
          const header = `<?xml version="1.0" encoding="UTF-8"?><ns0:feed xmlns:ns0="http://www.w3.org/2005/Atom"><ns0:link rel="self" href="${channel.link._text || 'https://example.com'}" type="application/atom+xml"/><ns0:link rel="alternate" href="${channel.link._text || 'https://example.com'}" type="text/html"/>`;

          const footer = `</ns0:feed>`;

          // الحد الأقصى لحجم الملف (1MB = 1048576 بايت)
          const MAX_FILE_SIZE = 1048576;
          let currentFileContent = header;
          let fileParts = [];
          let partNumber = 1;

          // حساب العدد الكلي للعناصر (المقالات + التعليقات) لتحديد التقدم
          const entriesArray = Array.isArray(entries) ? entries : [entries];
          let totalItems = entriesArray.length;
          if (!removeComments) {
            entriesArray.forEach(item => {
              const comments = item['wp:comment'] || [];
              totalItems += (Array.isArray(comments) ? comments : [comments]).filter(comment => comment['wp:comment_content']).length;
            });
          }
          let processedItems = 0;

          // تحديث التقدم
          updateProgress(processedItems, totalItems);

          // تحويل كل مقالة
          for (const [index, item] of entriesArray.entries()) {
            const postId = `post-${index}`; // معرف فريد للمقالة
            let title = item.title._text || item.title._cdata || 'بدون عنوان';
            let content = item['content:encoded']._cdata || item['content:encoded']._text || '';
            const pubDate = convertToISODate(item.pubDate._text); // تحويل التاريخ إلى صيغة ISO
            const categories = item.category || [];
            const author = {
              name: item['dc:creator']?._text || defaultAuthor.name,
              email: defaultAuthor.email,
              uri: item.link?._text || defaultAuthor.uri
            };

            // ترجمة العنوان إذا تم تفعيل الخيار
            if (translateContentOption) {
              title = await translateText(title, targetLanguage);
            }

            // تنسيق المحتوى مع تطبيق الخيارات
            let updatedContent = replaceImageUrls(content, imagePath);
            updatedContent = await formatContent(updatedContent, convertLinks, embedVideosOption, translateContentOption ? targetLanguage : '');
            updatedContent = `${updatedContent}<br/><br/>Publication Date: <strong>${convertDate(item.pubDate._text)}</strong>`;

            // تحديث التقدم بعد معالجة المقالة
            processedItems++;
            updateProgress(processedItems, totalItems);

            // إنشاء المقالة بدون فراغات أو أسطر فارغة
            let entryXML = `<ns0:entry><ns0:category term="http://schemas.google.com/blogger/2008/kind#post" scheme="http://schemas.google.com/g/2005#kind"/><ns0:id>${postId}</ns0:id><ns0:link rel="self" href="${item.link._text || 'https://example.com'}" type="application/atom+xml"/><ns0:title type="html"><![CDATA[${title}]]></ns0:title><ns0:content type="html"><![CDATA[${updatedContent}]]></ns0:content><ns0:published>${pubDate}</ns0:published><ns0:author><ns0:name>${author.name}</ns0:name><ns0:email>${author.email}</ns0:email><ns0:uri>${author.uri}</ns0:uri></ns0:author>`;

            // إضافة التصنيفات (labels) من ملف ووردبريس مع الترجمة
            if (Array.isArray(categories)) {
              for (const category of categories) {
                let catName = category._text || category._cdata;
                if (catName && translateContentOption) {
                  catName = await translateText(catName, targetLanguage);
                }
                if (catName) {
                  entryXML += `<ns0:category term="${catName}"/>`;
                }
              }
            } else if (categories._text || categories._cdata) {
              let catName = categories._text || categories._cdata;
              if (catName && translateContentOption) {
                catName = await translateText(catName, targetLanguage);
              }
              entryXML += `<ns0:category term="${catName}"/>`;
            }

            entryXML += `</ns0:entry>`;

            // استخراج وتحويل التعليقات (إن وجدت) إذا لم يتم تفعيل خيار إزالتها
            let commentsXML = '';
            if (!removeComments) {
              const comments = item['wp:comment'] || [];
              const processedCommentIds = new Set();
              for (const [commentIndex, comment] of (Array.isArray(comments) ? comments : [comments]).entries()) {
                if (!comment['wp:comment_content']) continue;
                const commentId = `${postId}-comment-${commentIndex}`;
                if (processedCommentIds.has(commentId)) continue;
                processedCommentIds.add(commentId);
                const commentAuthor = comment['wp:comment_author']?._text || 'Anonymous';
                const commentEmail = comment['wp:comment_author_email']?._text || 'anonymous@example.com';
                const commentUrl = comment['wp:comment_author_url']?._text || 'https://example.com';
                let commentContent = comment['wp:comment_content']._text || comment['wp:comment_content']._cdata || '';
                const commentDate = convertToISODate(comment['wp:comment_date']._text || item.pubDate._text, item.pubDate._text);

                // تنسيق محتوى التعليق مع تطبيق الخيارات
                const formattedCommentContent = await formatContent(commentContent, convertLinks, embedVideosOption, translateContentOption ? targetLanguage : '');

                commentsXML += `<ns0:entry><ns0:category term="http://schemas.google.com/blogger/2008/kind#comment" scheme="http://schemas.google.com/g/2005#kind"/><ns0:id>${commentId}</ns0:id><ns0:published>${commentDate}</ns0:published><ns0:author><ns0:name>${commentAuthor}</ns0:name><ns0:email>${commentEmail}</ns0:email><ns0:uri>${commentUrl}</ns0:uri></ns0:author><ns0:title type="text"><![CDATA[${commentContent.substring(0, 50)}...]]></ns0:title><ns0:content type="html"><![CDATA[${formattedCommentContent}]]></ns0:content><ns1:in-reply-to xmlns:ns1="http://purl.org/syndication/thread/1.0" ref="${postId}" type="application/atom+xml"/></ns0:entry>`;

                // تحديث التقدم بعد معالجة التعليق
                processedItems++;
                updateProgress(processedItems, totalItems);
              }
            }

            // إضافة المقالة والتعليقات إلى المحتوى الحالي
            const newContent = entryXML + commentsXML;
            const tempContent = currentFileContent + newContent;

            // حساب الحجم (بالبايت)
            const sizeInBytes = new TextEncoder().encode(tempContent).length;

            if (sizeInBytes > MAX_FILE_SIZE) {
              fileParts.push(currentFileContent + footer);
              currentFileContent = header + newContent;
            } else {
              currentFileContent = tempContent;
            }
          }

          // إضافة المحتوى المتبقي كملف أخير
          fileParts.push(currentFileContent + footer);

          // تنزيل الملفات
          fileParts.forEach((partContent, index) => {
            const blob = new Blob([partContent], { type: 'application/xml' });
            saveAs(blob, `blogger-feed-part${index + 1}.xml`);
          });

          status.textContent = `تم التحويل بنجاح! تم إنشاء ${fileParts.length} ملف${fileParts.length > 1 ? 'ات' : ''} وجارٍ التنزيل...`;
          updateProgress(totalItems, totalItems); // التأكد من أن الشريط يصل إلى 100%
        } catch (error) {
          status.textContent = 'حدث خطأ أثناء التحويل: ' + error.message;
          document.getElementById('progressContainer').style.display = 'none';
        }
      };

      reader.readAsText(file);
    });
  </script>
</body>
</html>
