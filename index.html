<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>تحويل ملف ووردبريس إلى بلوجر</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- استدعاء مكتبة xml-js من الملف المحلي -->
  <script src="xml-js.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
  <div class="bg-white p-8 rounded-lg shadow-lg max-w-md w-full">
    <h1 class="text-2xl font-bold mb-6 text-center text-blue-600">تحويل ملف ووردبريس إلى بلوجر</h1>
    <div class="mb-4">
      <label class="block text-gray-700 mb-2 font-medium" for="xmlFile">اختر ملف XML (ووردبريس):</label>
      <input type="file" id="xmlFile" accept=".xml" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
    </div>
    <div class="mb-4">
      <label class="block text-gray-700 mb-2 font-medium" for="imagePath">مسار استضافة الصور (اختياري):</label>
      <input type="text" id="imagePath" placeholder="مثال: https://your-host.com/images/" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
    </div>
    <button id="convertBtn" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600 transition duration-200">تحويل وتنزيل</button>
    <p id="status" class="mt-4 text-center text-gray-600"></p>
  </div>

  <!-- مكتبة FileSaver.js المحدثة -->
  <script>
    (function(global) {
      function saveAs(blob, name) {
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = name || 'download';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        setTimeout(() => window.URL.revokeObjectURL(url), 100);
      }
      global.saveAs = saveAs;
    })(this);
  </script>

  <!-- الكود الرئيسي لتحويل الملف -->
  <script>
    // دالة لهروب الأحرف الخاصة في XML
    function escapeXML(str) {
      return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&apos;');
    }

    // تحويل تاريخ ووردبريس إلى تاريخ بلوجر (تنسيق محسّن)
    function convertDate(wpDate) {
      const date = new Date(wpDate);
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${day}/${month}/${year} ${hours}:${minutes}`;
    }

    // تحويل تاريخ ووردبريس إلى صيغة ISO
    function convertToISODate(wpDate) {
      const date = new Date(wpDate);
      return date.toISOString(); // تنسيق ISO مثل 2017-05-29T00:14:40Z
    }

    // استبدال روابط الصور بمسار جديد إذا تم تحديده
    function replaceImageUrls(content, imagePath) {
      if (!imagePath) return content;
      const imageUrlPattern = /<img[^>]+src=["'](.*?)["']/g;
      return content.replace(imageUrlPattern, (match, url) => {
        const newUrl = imagePath + url.substring(url.lastIndexOf('/') + 1);
        return newUrl; // إدراج الرابط كنص خام
      });
    }

    // تنسيق المحتوى (تحويل كل شيء إلى نصوص خام)
    function formatContent(content) {
      let formattedContent = content;

      // إزالة عناصر HTML مثل <a>, <img>, <h2> وتحويلها إلى نصوص خام
      formattedContent = formattedContent.replace(/<a[^>]+href=["'](.*?)["'][^>]*>(.*?)<\/a>/g, '$1'); // تحويل الروابط إلى نصوص خام
      formattedContent = formattedContent.replace(/<img[^>]+src=["'](.*?)["'][^>]*>/g, '$1'); // تحويل الصور إلى روابط خام
      formattedContent = formattedContent.replace(/<\/?h[1-6][^>]*>/g, ''); // إزالة عناوين HTML مثل <h2>

      // استبدال التواريخ
      const datePattern = /\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\+\d{2}:\d{2}/g;
      formattedContent = formattedContent.replace(datePattern, (date) => `<strong>${convertDate(date)}</strong>`);

      return formattedContent;
    }

    // تحويل الملف
    document.getElementById('convertBtn').addEventListener('click', function () {
      const fileInput = document.getElementById('xmlFile');
      const imagePath = document.getElementById('imagePath').value.trim();
      const status = document.getElementById('status');

      if (!fileInput.files.length) {
        status.textContent = 'الرجاء اختيار ملف XML!';
        return;
      }

      const file = fileInput.files[0];
      const reader = new FileReader();

      reader.onload = function (e) {
        const xmlContent = e.target.result;
        status.textContent = 'جارٍ التحويل...';

        try {
          // تحويل XML إلى JSON باستخدام xml-js
          const json = xml2js(xmlContent, { compact: true, spaces: 2 });
          const channel = json.rss.channel;
          const entries = channel.item;

          // استخراج بيانات المؤلف العامة (إن وجدت)
          const defaultAuthor = {
            name: channel['dc:creator']?._text || 'Unknown Author',
            email: 'unknown@example.com',
            uri: channel.link?._text || 'https://example.com'
          };

          // رأس الملف (كل شيء في سطر واحد)
          const header = `<?xml version="1.0" encoding="UTF-8"?><ns0:feed xmlns:ns0="http://www.w3.org/2005/Atom"><ns0:link rel="self" href="${channel.link._text || 'https://example.com'}" type="application/atom+xml"/><ns0:link rel="alternate" href="${channel.link._text || 'https://example.com'}" type="text/html"/>`;

          const footer = `</ns0:feed>`;

          // الحد الأقصى لحجم الملف (1MB = 1048576 بايت)
          const MAX_FILE_SIZE = 1048576;
          let currentFileContent = header;
          let fileParts = [];
          let partNumber = 1;

          // تحويل كل مقالة
          (Array.isArray(entries) ? entries : [entries]).forEach((item, index) => {
            const postId = `post-${index}`; // معرف فريد للمقالة (مطابق للملف المرفق)
            const title = escapeXML(item.title._text || item.title._cdata || 'بدون عنوان'); // هروب العنوان
            const content = item['content:encoded']._cdata || item['content:encoded']._text || '';
            const pubDate = convertToISODate(item.pubDate._text); // تحويل التاريخ إلى صيغة ISO
            const categories = item.category || [];
            const author = {
              name: escapeXML(item['dc:creator']?._text || defaultAuthor.name),
              email: defaultAuthor.email,
              uri: item.link?._text || defaultAuthor.uri
            };

            // تنسيق المحتوى
            let updatedContent = replaceImageUrls(content, imagePath);
            updatedContent = formatContent(updatedContent);
            updatedContent = `${updatedContent}<br/><br/>Publication Date: <strong>${convertDate(item.pubDate._text)}</strong>`;
            updatedContent = escapeXML(updatedContent); // هروب المحتوى

            // إنشاء المقالة (كل شيء في سطر واحد، بدون CDATA)
            let entryXML = `<ns0:entry><ns0:category term="http://schemas.google.com/blogger/2008/kind#post" scheme="http://schemas.google.com/g/2005#kind"/><ns0:id>${postId}</ns0:id><ns0:link rel="self" href="${item.link._text || 'https://example.com'}" type="application/atom+xml"/><ns0:title type="html">${title}</ns0:title><ns0:content type="html">${updatedContent}</ns0:content><ns0:published>${pubDate}</ns0:published><ns0:author><ns0:name>${author.name}</ns0:name><ns0:email>${author.email}</ns0:email><ns0:uri>${author.uri}</ns0:uri></ns0:author>`;

            // إضافة التصنيفات (labels)
            if (Array.isArray(categories)) {
              categories.forEach(category => {
                const catName = category._text || category._cdata;
                if (catName) {
                  entryXML += `<ns0:category term="http://www.blogger.com/atom/ns#"/>`;
                }
              });
            } else if (categories._text || categories._cdata) {
              const catName = categories._text || categories._cdata;
              entryXML += `<ns0:category term="http://www.blogger.com/atom/ns#"/>`;
            }

            entryXML += `</ns0:entry>`;

            // استخراج وتحويل التعليقات (إن وجدت)
            const comments = item['wp:comment'] || [];
            let commentsXML = '';
            (Array.isArray(comments) ? comments : [comments]).forEach((comment, commentIndex) => {
              if (!comment['wp:comment_content']) return; // تجاهل التعليقات الفارغة
              const commentId = `${postId}.comment-${commentIndex}`;
              const commentAuthor = escapeXML(comment['wp:comment_author']?._text || 'Anonymous');
              const commentEmail = comment['wp:comment_author_email']?._text || 'anonymous@example.com';
              const commentUrl = comment['wp:comment_author_url']?._text || 'https://example.com';
              const commentContent = escapeXML(comment['wp:comment_content']._text || comment['wp:comment_content']._cdata || '');
              const commentDate = convertToISODate(comment['wp:comment_date']._text || item.pubDate._text);
              const commentTitle = escapeXML(commentContent.substring(0, 50) + '...');

              commentsXML += `<ns0:entry><ns0:author><ns0:name>${commentAuthor}</ns0:name><ns0:email>${commentEmail}</ns0:email><ns0:uri>${commentUrl}</ns0:uri></ns0:author><ns0:category term="http://schemas.google.com/blogger/2008/kind#comment" scheme="http://schemas.google.com/g/2005#kind"/><ns0:id>${commentId}</ns0:id><ns0:link rel="self" href="${item.link._text || 'https://example.com'}" type="application/atom+xml"/><ns0:title type="text">${commentTitle}</ns0:title><ns0:content type="html">${commentContent}</ns0:content><ns0:published>${commentDate}</ns0:published><ns1:in-reply-to xmlns:ns1="http://purl.org/syndication/thread/1.0" ref="${postId}" type="application/atom+xml"/></ns0:entry>`;
            });

            // إضافة المقالة والتعليقات إلى المحتوى الحالي
            const newContent = entryXML + commentsXML;
            const tempContent = currentFileContent + newContent;

            // حساب الحجم (بالبايت)
            const sizeInBytes = new TextEncoder().encode(tempContent).length;

            if (sizeInBytes > 1048576) {
              // إذا تجاوز الحجم 1MB، أغلق الملف الحالي وابدأ ملفًا جديدًا
              fileParts.push(currentFileContent + footer);
              currentFileContent = header + newContent;
            } else {
              currentFileContent = tempContent;
            }
          });

          // إضافة المحتوى المتبقي كملف أخير
          fileParts.push(currentFileContent + footer);

          // تنزيل الملفات
          fileParts.forEach((partContent, index) => {
            const blob = new Blob([partContent], { type: 'application/xml' });
            saveAs(blob, `blogger-feed-part${index + 1}.xml`);
          });

          status.textContent = `تم التحويل بنجاح! تم إنشاء ${fileParts.length} ملف${fileParts.length > 1 ? 'ات' : ''} وجارٍ التنزيل...`;
        } catch (error) {
          status.textContent = 'حدث خطأ أثناء التحويل: ' + error.message;
        }
      };

      reader.readAsText(file);
    });
  </script>
</body>
</html>
