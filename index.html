<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>تحويل ملف ووردبريس إلى بلوجر</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- تحميل مكتبة xml-js -->
  <script src="https://cdn.jsdelivr.net/npm/xml-js@1.6.11/dist/xml-js.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
  <div class="bg-white p-8 rounded-lg shadow-lg max-w-md w-full">
    <h1 class="text-2xl font-bold mb-6 text-center text-blue-600">تحويل ملف ووردبريس إلى بلوجر</h1>
    <div class="mb-4">
      <label class="block text-gray-700 mb-2 font-medium" for="xmlFile">اختر ملف XML (ووردبريس):</label>
      <input type="file" id="xmlFile" accept=".xml" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
    </div>
    <div class="mb-4">
      <label class="block text-gray-700 mb-2 font-medium" for="imagePath">مسار استضافة الصور (اختياري):</label>
      <input type="text" id="imagePath" placeholder="مثال: https://your-host.com/images/" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
    </div>
    <button id="convertBtn" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600 transition duration-200">تحويل وتنزيل</button>
    <p id="status" class="mt-4 text-center text-gray-600"></p>
  </div>

  <!-- مكتبة FileSaver.js المحدثة -->
  <script>
    (function(global) {
      function saveAs(blob, name) {
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = name || 'download';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        setTimeout(() => window.URL.revokeObjectURL(url), 100);
      }
      global.saveAs = saveAs;
    })(this);
  </script>

  <!-- الكود الرئيسي لتحويل الملف -->
  <script>
    document.getElementById('convertBtn').addEventListener('click', async () => {
      const fileInput = document.getElementById('xmlFile');
      const imagePath = document.getElementById('imagePath').value;
      const status = document.getElementById('status');

      if (!fileInput.files.length) {
        status.textContent = 'يرجى اختيار ملف XML!';
        status.className = 'mt-4 text-center text-red-600';
        return;
      }

      if (typeof xml2js === 'undefined') {
        status.textContent = 'خطأ: مكتبة xml-js غير متاحة.';
        status.className = 'mt-4 text-center text-red-600';
        console.log('xml2js غير معرف:', window.xml2js);
        return;
      }

      if (typeof saveAs === 'undefined') {
        status.textContent = 'خطأ: مكتبة FileSaver غير متاحة.';
        status.className = 'mt-4 text-center text-red-600';
        return;
      }

      status.textContent = 'جارٍ المعالجة...';
      status.className = 'mt-4 text-center text-blue-600';
      const file = fileInput.files[0];
      const reader = new FileReader();

      reader.onload = async (e) => {
        try {
          const xmlText = e.target.result;

          // تحويل XML إلى JSON باستخدام xml-js
          const json = xml2js(xmlText, { compact: true, spaces: 2, nativeType: true });

          // تصحيح الأخطاء: طباعة البيانات للتأكد من التحويل
          console.log('JSON المحول:', json);

          // استخراج بيانات القناة والمنشورات
          const channel = json.rss?.channel || {};
          const posts = channel.item || [];
          const blogTitle = channel.title?._text || 'Converted Blog';
          const blogLink = channel.link?._text || 'https://example.com';
          const updatedDate = channel.lastBuildDate?._text || channel.pubDate?._text || new Date().toISOString();

          // التحقق من وجود منشورات
          if (!posts || (Array.isArray(posts) && posts.length === 0) || (!Array.isArray(posts) && !posts.title)) {
            status.textContent = 'خطأ: لا توجد منشورات في الملف! تأكد من هيكل الملف.';
            status.className = 'mt-4 text-center text-red-600';
            console.log('المنشورات المستخرجة:', posts);
            return;
          }

          const postsArray = Array.isArray(posts) ? posts : [posts];

          // رأس ملف Atom XML (سيُستخدم في كل ملف)
          const feedHeader = `<?xml version="1.0" encoding="UTF-8"?>
<ns0:feed xmlns:ns0="http://www.w3.org/2005/Atom" xmlns:thr="http://purl.org/syndication/thread/1.0">
  <ns0:title type="html">${blogTitle}</ns0:title>
  <ns0:updated>${updatedDate}</ns0:updated>
  <ns0:id>tag:blogger.com,1999:blog-converted</ns0:id>
  <ns0:generator>Blogger</ns0:generator>
  <ns0:link rel="self" href="${blogLink}" type="application/atom+xml"/>
  <ns0:link rel="alternate" href="${blogLink}" type="text/html"/>`;

          const feedFooter = `</ns0:feed>`;

          // إنشاء المنشورات (كل منشور كسلسلة نصية)
          const entries = postsArray.map((post, index) => {
            const title = post.title?._text || post.title?._cdata || 'بدون عنوان';
            let content = post['content:encoded']?._cdata || post['content:encoded']?._text || post.description?._text || '';
            const pubDate = post.pubDate?._text || new Date().toISOString();
            const postId = `post-${index + 1}`;
            const author = post['dc:creator']?._text || 'Unknown';
            const postLink = post.link?._text || blogLink;
            let categories = Array.isArray(post.category) ? post.category : post.category ? [post.category] : [];

            categories = categories
              .map(cat => {
                if (typeof cat === 'string') return cat;
                return cat._cdata || cat._text || '';
              })
              .filter(cat => cat && typeof cat === 'string');

            categories = [
              ...categories,
              'http://schemas.google.com/blogger/2008/kind#post',
              'Sin categoría'
            ];

            if (imagePath) {
              content = content.replace(/(<img[^>]+src=")([^"]+)(")/gi, (match, p1, p2, p3) => {
                if (p2.startsWith('http://') || p2.startsWith('https://')) {
                  return match;
                }
                return `${p1}${imagePath}${p2}${p3}`;
              });
            }

            content = content.replace(/ /g, ' ').replace(/[\u0000-\u001F\u007F-\u009F]/g, '');

            return `
  <ns0:entry>
    <ns0:id>tag:blogger.com,1999:${postId}</ns0:id>
    <ns0:published>${pubDate}</ns0:published>
    <ns0:updated>${pubDate}</ns0:updated>
    <ns0:title type="text">${title}</ns0:title>
    <ns0:content type="html"><![CDATA[${content}]]></ns0:content>
    <ns0:author><ns0:name>${author}</ns0:name></ns0:author>
    ${categories.map(cat => `<ns0:category term="${cat}" ${typeof cat === 'string' && cat.startsWith('http') ? `scheme="${cat.split('#')[0]}"` : ''}/>`).join('')}
    <ns0:link rel="self" href="${postLink}" type="application/atom+xml"/>
    <ns0:link rel="alternate" href="${postLink}" type="text/html"/>
    <thr:total>0</thr:total>
  </ns0:entry>`;
          });

          // تقسيم المنشورات إلى ملفات بحجم أقل من 1 ميجابايت
          const MAX_FILE_SIZE = 1 * 1024 * 1024; // 1 ميجابايت
          let currentFileContent = feedHeader;
          let currentFileSize = new TextEncoder().encode(currentFileContent).length;
          let fileIndex = 1;
          const files = [];

          for (const entry of entries) {
            const entrySize = new TextEncoder().encode(entry).length;
            const footerSize = new TextEncoder().encode(feedFooter).length;

            // إذا أضيف المنشور الحالي وأصبح الحجم أكبر من 1 ميجابايت، أغلق الملف الحالي وابدأ ملفًا جديدًا
            if (currentFileSize + entrySize + footerSize > MAX_FILE_SIZE) {
              currentFileContent += feedFooter;
              files.push({ content: currentFileContent, index: fileIndex });
              fileIndex++;
              currentFileContent = feedHeader;
              currentFileSize = new TextEncoder().encode(currentFileContent).length;
            }

            currentFileContent += entry;
            currentFileSize += entrySize;
          }

          // إضافة الملف الأخير إذا كان يحتوي على منشورات
          if (currentFileSize > new TextEncoder().encode(feedHeader).length) {
            currentFileContent += feedFooter;
            files.push({ content: currentFileContent, index: fileIndex });
          }

          // تنزيل الملفات
          files.forEach(file => {
            const blob = new Blob([file.content], { type: 'application/xml' });
            saveAs(blob, `blogger_export_part${file.index}.xml`);
          });

          status.textContent = `تم التحويل بنجاح! تم إنشاء ${files.length} ملف${files.length > 1 ? 'ات' : ''} جاهزة للتنزيل.`;
          status.className = 'mt-4 text-center text-green-600';
        } catch (error) {
          status.textContent = 'خطأ أثناء التحويل: ' + error.message;
          status.className = 'mt-4 text-center text-red-600';
          console.error(error);
        }
      };

      reader.readAsText(file);
    });
  </script>
</body>
</html>
