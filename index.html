<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>تحويل ملف ووردبريس إلى بلوجر</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- استدعاء مكتبة xml-js من الملف المحلي -->
  <script src="xml-js.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
  <div class="bg-white p-8 rounded-lg shadow-lg max-w-md w-full">
    <h1 class="text-2xl font-bold mb-6 text-center text-blue-600">تحويل ملف ووردبريس إلى بلوجر</h1>
    <div class="mb-4">
      <label class="block text-gray-700 mb-2 font-medium" for="xmlFile">اختر ملف XML (ووردبريس):</label>
      <input type="file" id="xmlFile" accept=".xml" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
    </div>
    <div class="mb-4">
      <label class="block text-gray-700 mb-2 font-medium" for="imagePath">مسار استضافة الصور (اختياري):</label>
      <input type="text" id="imagePath" placeholder="مثال: https://your-host.com/images/" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
    </div>
    <button id="convertBtn" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600 transition duration-200">تحويل وتنزيل</button>
    <p id="status" class="mt-4 text-center text-gray-600"></p>
  </div>

  <!-- مكتبة FileSaver.js المحدثة -->
  <script>
    (function(global) {
      function saveAs(blob, name) {
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = name || 'download';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        setTimeout(() => window.URL.revokeObjectURL(url), 100);
      }
      global.saveAs = saveAs;
    })(this);
  </script>

  <!-- الكود الرئيسي لتحويل الملف -->
  <script>
    // تحويل تاريخ ووردبريس إلى تاريخ بلوجر (تنسيق محسّن)
    function convertDate(wpDate) {
      const date = new Date(wpDate);
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${day}/${month}/${year} ${hours}:${minutes}`;
    }

    // تحويل روابط الفيديو إلى iframe للتضمين في بلوجر
    function embedVideo(content) {
      const videoPattern = /\[embed\](https?:\/\/(www\.)?(youtube\.com|youtu\.be)\/[^\s]+)\[\/embed\]/g;
      return content.replace(videoPattern, (match, url) => {
        const videoIdMatch = url.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/);
        const videoId = videoIdMatch ? videoIdMatch[1] : null;
        if (videoId) {
          return `<iframe width="560" height="315" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe><br/>`;
        }
        return url;
      });
    }

    // تحويل الروابط النصية إلى روابط قابلة للنقر
    function linkify(content) {
      const urlPattern = /(https?:\/\/[^\s<]+)(?![^<]*>|[^<>]*<\/a>)/g;
      return content.replace(urlPattern, '<a href="$1" target="_blank">$1</a><br/>');
    }

    // استبدال روابط الصور بمسار جديد إذا تم تحديده
    function replaceImageUrls(content, imagePath) {
      if (!imagePath) return content;
      const imageUrlPattern = /<img[^>]+src=["'](.*?)["']/g;
      return content.replace(imageUrlPattern, (match, url) => {
        const newUrl = imagePath + url.substring(url.lastIndexOf('/') + 1);
        return match.replace(url, newUrl);
      });
    }

    // تنسيق المحتوى (الفيديو، الروابط، التواريخ)
    function formatContent(content) {
      let formattedContent = content;
      formattedContent = embedVideo(formattedContent);
      formattedContent = linkify(formattedContent);
      const datePattern = /\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\+\d{2}:\d{2}/g;
      formattedContent = formattedContent.replace(datePattern, (date) => `<strong>${convertDate(date)}</strong>`);
      return formattedContent;
    }

    // تحويل الملف
    document.getElementById('convertBtn').addEventListener('click', function () {
      const fileInput = document.getElementById('xmlFile');
      const imagePath = document.getElementById('imagePath').value.trim();
      const status = document.getElementById('status');

      if (!fileInput.files.length) {
        status.textContent = 'الرجاء اختيار ملف XML!';
        return;
      }

      const file = fileInput.files[0];
      const reader = new FileReader();

      reader.onload = function (e) {
        const xmlContent = e.target.result;
        status.textContent = 'جارٍ التحويل...';

        try {
          // تحويل XML إلى JSON باستخدام xml-js
          const json = xml2js(xmlContent, { compact: true, spaces: 2 });
          const channel = json.rss.channel;
          const entries = channel.item;

          // استخراج بيانات المؤلف العامة (إن وجدت)
          const defaultAuthor = {
            name: channel['dc:creator']?._text || 'Unknown Author',
            email: 'unknown@example.com',
            uri: channel.link?._text || 'https://example.com'
          };

          // رأس الملف
          const header = `<?xml version="1.0" encoding="UTF-8"?>
<!-- ملف XML محول لاستيراده إلى بلوجر -->
<feed xmlns="http://www.w3.org/2005/Atom">
  <!-- معلومات عامة عن الـ Feed -->
  <title>${channel.title._text || 'Converted Feed'}</title>
  <id>tag:blogger.com,1999:blog-123456789</id>
  <updated>${new Date().toISOString()}</updated>
  <generator>Custom Converter</generator>
  <link rel="self" href="${channel.link._text || 'https://example.com'}" type="application/atom+xml"/>
  <link rel="alternate" href="${channel.link._text || 'https://example.com'}" type="text/html"/>`;

          const footer = `</feed>`;

          // الحد الأقصى لحجم الملف (1MB = 1048576 بايت)
          const MAX_FILE_SIZE = 1048576;
          let currentFileContent = header;
          let fileParts = [];
          let partNumber = 1;

          // تحويل كل مقالة
          (Array.isArray(entries) ? entries : [entries]).forEach((item, index) => {
            const postId = `tag:blogger.com,1999:blog-123456789.post-${index}`; // معرف فريد للمقالة
            const title = item.title._text || item.title._cdata || 'بدون عنوان';
            const content = item['content:encoded']._cdata || item['content:encoded']._text || '';
            const pubDate = item.pubDate._text;
            const categories = item.category || [];
            const author = {
              name: item['dc:creator']?._text || defaultAuthor.name,
              email: defaultAuthor.email,
              uri: item.link?._text || defaultAuthor.uri
            };

            // تنسيق المحتوى
            let updatedContent = replaceImageUrls(content, imagePath);
            updatedContent = formatContent(updatedContent);
            updatedContent = `${updatedContent}<br/><br/>Publication Date: <strong>${convertDate(pubDate)}</strong>`;

            let entryXML = `
  <!-- مقالة جديدة -->
  <entry>
    <id>${postId}</id>
    <title type="html">${title}</title>
    <content type="html"><![CDATA[${updatedContent}]]></content>
    <published>${pubDate}</published>
    <updated>${pubDate}</updated>
    <link rel="self" href="${item.link._text || 'https://example.com'}" type="application/atom+xml"/>
    <link rel="alternate" href="${item.link._text || 'https://example.com'}" type="text/html"/>
    <category term="http://schemas.google.com/blogger/2008/kind#post" scheme="http://schemas.google.com/g/2005#kind"/>
    <author>
      <name>${author.name}</name>
      <email>${author.email}</email>
      <uri>${author.uri}</uri>
    </author>`;

            // إضافة التصنيفات (labels)
            if (Array.isArray(categories)) {
              categories.forEach(category => {
                const catName = category._text || category._cdata;
                if (catName) {
                  entryXML += `
    <category scheme="http://www.blogger.com/atom/ns#" term="${catName}" />`;
                }
              });
            } else if (categories._text || categories._cdata) {
              const catName = categories._text || categories._cdata;
              entryXML += `
    <category scheme="http://www.blogger.com/atom/ns#" term="${catName}" />`;
            }

            entryXML += `
  </entry>`;

            // استخراج وتحويل التعليقات (إن وجدت)
            const comments = item['wp:comment'] || [];
            let commentsXML = '';
            (Array.isArray(comments) ? comments : [comments]).forEach((comment, commentIndex) => {
              if (!comment['wp:comment_content']) return; // تجاهل التعليقات الفارغة
              const commentId = `tag:blogger.com,1999:${postId}.comment-${commentIndex}`;
              const commentAuthor = comment['wp:comment_author']?._text || 'Anonymous';
              const commentEmail = comment['wp:comment_author_email']?._text || 'anonymous@example.com';
              const commentUrl = comment['wp:comment_author_url']?._text || 'https://example.com';
              const commentContent = comment['wp:comment_content']._text || comment['wp:comment_content']._cdata || '';
              const commentDate = comment['wp:comment_date']._text || pubDate;

              commentsXML += `
  <!-- تعليق جديد -->
  <entry>
    <id>${commentId}</id>
    <title type="text">${commentContent.substring(0, 50)}...</title>
    <content type="html"><![CDATA[${commentContent}]]></content>
    <published>${commentDate}</published>
    <author>
      <name>${commentAuthor}</name>
      <email>${commentEmail}</email>
      <uri>${commentUrl}</uri>
    </author>
    <category term="http://schemas.google.com/blogger/2008/kind#comment" scheme="http://schemas.google.com/g/2005#kind"/>
    <in-reply-to ref="${postId}" type="application/atom+xml"/>
  </entry>`;
            });

            // إضافة المقالة والتعليقات إلى المحتوى الحالي
            const newContent = entryXML + commentsXML;
            const tempContent = currentFileContent + newContent;

            // حساب الحجم (بالبايت)
            const sizeInBytes = new TextEncoder().encode(tempContent).length;

            if (sizeInBytes > MAX_FILE_SIZE) {
              // إذا تجاوز الحجم 1MB، أغلق الملف الحالي وابدأ ملفًا جديدًا
              fileParts.push(currentFileContent + footer);
              currentFileContent = header + newContent;
            } else {
              currentFileContent = tempContent;
            }
          });

          // إضافة المحتوى المتبقي كملف أخير
          fileParts.push(currentFileContent + footer);

          // تنزيل الملفات
          fileParts.forEach((partContent, index) => {
            const blob = new Blob([partContent], { type: 'application/xml' });
            saveAs(blob, `blogger-feed-part${index + 1}.xml`);
          });

          status.textContent = `تم التحويل بنجاح! تم إنشاء ${fileParts.length} ملف${fileParts.length > 1 ? 'ات' : ''} وجارٍ التنزيل...`;
        } catch (error) {
          status.textContent = 'حدث خطأ أثناء التحويل: ' + error.message;
        }
      };

      reader.readAsText(file);
    });
  </script>
</body>
</html>
