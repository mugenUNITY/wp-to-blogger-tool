<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>تحويل ملف ووردبريس إلى بلوجر</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- استدعاء مكتبة xml-js من الملف المحلي -->
  <script src="xml-js.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
  <div class="bg-white p-8 rounded-lg shadow-lg max-w-md w-full">
    <h1 class="text-2xl font-bold mb-6 text-center text-blue-600">تحويل ملف ووردبريس إلى بلوجر</h1>
    <div class="mb-4">
      <label class="block text-gray-700 mb-2 font-medium" for="xmlFile">اختر ملف XML (ووردبريس):</label>
      <input type="file" id="xmlFile" accept=".xml" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
    </div>
    <div class="mb-4">
      <label class="block text-gray-700 mb-2 font-medium" for="imagePath">مسار استضافة الصور (اختياري):</label>
      <input type="text" id="imagePath" placeholder="مثال: https://your-host.com/images/" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
    </div>
    <button id="convertBtn" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600 transition duration-200">تحويل وتنزيل</button>
    <p id="status" class="mt-4 text-center text-gray-600"></p>
  </div>

  <!-- مكتبة FileSaver.js المحدثة -->
  <script>
    (function(global) {
      function saveAs(blob, name) {
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = name || 'download';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        setTimeout(() => window.URL.revokeObjectURL(url), 100);
      }
      global.saveAs = saveAs;
    })(this);
  </script>

  <!-- الكود الرئيسي لتحويل الملف -->
  <script>
    // تحويل تاريخ ووردبريس إلى تاريخ بلوجر
    function convertDate(wpDate) {
      const date = new Date(wpDate);
      return date.toISOString().replace(/\.[\d]{3}Z$/, '+00:00');
    }

    // استبدال روابط الصور بمسار جديد إذا تم تحديده
    function replaceImageUrls(content, imagePath) {
      if (!imagePath) return content;
      const imageUrlPattern = /<img[^>]+src=["'](.*?)["']/g;
      return content.replace(imageUrlPattern, (match, url) => {
        const newUrl = imagePath + url.substring(url.lastIndexOf('/') + 1);
        return match.replace(url, newUrl);
      });
    }

    // تحويل الملف
    document.getElementById('convertBtn').addEventListener('click', function () {
      const fileInput = document.getElementById('xmlFile');
      const imagePath = document.getElementById('imagePath').value.trim();
      const status = document.getElementById('status');

      if (!fileInput.files.length) {
        status.textContent = 'الرجاء اختيار ملف XML!';
        return;
      }

      const file = fileInput.files[0];
      const reader = new FileReader();

      reader.onload = function (e) {
        const xmlContent = e.target.result;
        status.textContent = 'جارٍ التحويل...';

        try {
          // تحويل XML إلى JSON باستخدام xml-js
          const json = xml2js(xmlContent, { compact: true, spaces: 2 });
          const entries = json.rss.channel.item;

          // إنشاء ملف XML جديد متوافق مع بلوجر
          let bloggerXML = `<?xml version="1.0" encoding="UTF-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Converted Feed</title>
  <id>ConvertedFeed</id>
  <updated>${new Date().toISOString()}</updated>
  <generator>Custom Converter</generator>`;

          // تحويل كل مقالة
          (Array.isArray(entries) ? entries : [entries]).forEach(item => {
            const title = item.title._text || item.title._cdata || 'بدون عنوان';
            const content = item['content:encoded']._cdata || item['content:encoded']._text || '';
            const pubDate = convertDate(item.pubDate._text);
            const categories = item.category || [];
            const updatedContent = replaceImageUrls(content, imagePath);

            bloggerXML += `
  <entry>
    <title type="html">${title}</title>
    <content type="html"><![CDATA[${updatedContent}]]></content>
    <published>${pubDate}</published>
    <updated>${pubDate}</updated>`;

            // إضافة التصنيفات (labels)
            if (Array.isArray(categories)) {
              categories.forEach(category => {
                const catName = category._text || category._cdata;
                if (catName) {
                  bloggerXML += `
    <category scheme="http://www.blogger.com/atom/ns#" term="${catName}" />`;
                }
              });
            } else if (categories._text || categories._cdata) {
              const catName = categories._text || categories._cdata;
              bloggerXML += `
    <category scheme="http://www.blogger.com/atom/ns#" term="${catName}" />`;
            }

            bloggerXML += `
  </entry>`;
          });

          bloggerXML += `
</feed>`;

          // تنزيل الملف
          const blob = new Blob([bloggerXML], { type: 'application/xml' });
          saveAs(blob, 'blogger-feed.xml');
          status.textContent = 'تم التحويل بنجاح! جارٍ التنزيل...';
        } catch (error) {
          status.textContent = 'حدث خطأ أثناء التحويل: ' + error.message;
        }
      };

      reader.readAsText(file);
    });
  </script>
</body>
</html>
